-- Create database schema
CREATE DATABASE IF NOT EXISTS layoffs_db;
USE layoffs_db;

-- Create raw table to import data as-is (all VARCHAR for flexibility)
CREATE TABLE IF NOT EXISTS layoffs_raw (
    company VARCHAR(255),
    location VARCHAR(255),
    total_laid_off VARCHAR(50),
    `date` VARCHAR(50),
    percentage_laid_off VARCHAR(50),
    industry VARCHAR(255),
    `source` VARCHAR(255),
    stage VARCHAR(255),
    funds_raised VARCHAR(255),
    country VARCHAR(255),
    date_added VARCHAR(50)
);

-- ===
-- IMPORT YOUR DATA INTO layoffs_raw USING YOUR SQL TOOL
-- Example:
-- LOAD DATA INFILE 'path/to/layoffs.csv'
-- INTO TABLE layoffs_raw
-- FIELDS TERMINATED BY ','
-- ENCLOSED BY '"'
-- LINES TERMINATED BY '\n'
-- IGNORE 1 ROWS;
-- ===

-- Create clean staging table with same columns but ready for cleaning
CREATE TABLE IF NOT EXISTS layoffs_staging LIKE layoffs_raw;

-- Insert raw data into staging
INSERT INTO layoffs_staging
SELECT * FROM layoffs_raw;

-- Trim whitespace from all string columns in staging table
UPDATE layoffs_staging SET
    company = TRIM(company),
    location = TRIM(location),
    total_laid_off = TRIM(total_laid_off),
    `date` = TRIM(`date`),
    percentage_laid_off = TRIM(percentage_laid_off),
    industry = TRIM(industry),
    `source` = TRIM(`source`),
    stage = TRIM(stage),
    funds_raised = TRIM(funds_raised),
    country = TRIM(country),
    date_added = TRIM(date_added);

-- Convert date strings to DATE type (update columns after conversion)
UPDATE layoffs_staging
SET `date` = STR_TO_DATE(`date`, '%m/%d/%Y'),
    date_added = STR_TO_DATE(date_added, '%m/%d/%Y');

ALTER TABLE layoffs_staging
    MODIFY COLUMN `date` DATE,
    MODIFY COLUMN date_added DATE;

-- Remove empty rows where both total_laid_off and percentage_laid_off are empty
DELETE FROM layoffs_staging
WHERE TRIM(total_laid_off) = '' AND TRIM(percentage_laid_off) = '';

-- Convert total_laid_off to integer column
ALTER TABLE layoffs_staging ADD COLUMN total_laid_off_int INT;

UPDATE layoffs_staging
SET total_laid_off_int = 
  CASE 
    WHEN total_laid_off REGEXP '^[0-9]+$' THEN CAST(total_laid_off AS SIGNED)
    ELSE NULL
  END;

-- Convert percentage_laid_off to decimal column
ALTER TABLE layoffs_staging ADD COLUMN percentage_laid_off_decimal DECIMAL(5,2);

UPDATE layoffs_staging
SET percentage_laid_off_decimal = 
  CASE 
    WHEN percentage_laid_off REGEXP '^[0-9]+(\.[0-9]+)?$' THEN ROUND(CAST(percentage_laid_off AS DECIMAL(10,4)), 2)
    ELSE NULL
  END;

-- Remove duplicates based on key columns
ALTER TABLE layoffs_staging ADD COLUMN temp_id INT AUTO_INCREMENT PRIMARY KEY;

WITH CTE_dup AS (
  SELECT temp_id,
         ROW_NUMBER() OVER (
           PARTITION BY company, location, `date`, country
           ORDER BY temp_id
         ) AS row_num
  FROM layoffs_staging
)
DELETE FROM layoffs_staging
WHERE temp_id IN (SELECT temp_id FROM CTE_dup WHERE row_num > 1);

ALTER TABLE layoffs_staging DROP COLUMN temp_id;

-- Drop original columns replaced by cleaned ones
ALTER TABLE layoffs_staging
DROP COLUMN total_laid_off,
DROP COLUMN percentage_laid_off;

-- Final summary counts of data completeness
SELECT 
  SUM(CASE WHEN total_laid_off_int IS NOT NULL AND percentage_laid_off_decimal IS NOT NULL THEN 1 ELSE 0 END) AS complete_data,
  SUM(CASE WHEN total_laid_off_int IS NOT NULL AND percentage_laid_off_decimal IS NULL THEN 1 ELSE 0 END) AS missing_percentage,
  SUM(CASE WHEN total_laid_off_int IS NULL AND percentage_laid_off_decimal IS NOT NULL THEN 1 ELSE 0 END) AS missing_total,
  SUM(CASE WHEN total_laid_off_int IS NULL AND percentage_laid_off_decimal IS NULL THEN 1 ELSE 0 END) AS missing_both
FROM layoffs_staging;

-- Done! You can now query layoffs_staging as your cleaned dataset.
